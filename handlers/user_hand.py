from random import choice, random
from aiogram import Dispatcher, Bot, types, Router, F
from aiogram.filters import CommandStart, Command
from aiogram.fsm.context import FSMContext
from aiogram.types import Message
from aiogram.utils.markdown import hbold, hitalic
from states.user_fsm import Registration
from keyboards.user_keyboard import start_button, request_phone_keyboard
from config import BotConfig

user_router = Router()

@user_router.message(CommandStart())
async def cmd_start(msg: Message, config: BotConfig) -> None:
    if msg.from_user.id not in config.admin_ids:
        await msg.answer(config.welcome_message, reply_markup=start_button)
    else:
        await msg.answer(f"{hbold('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä!')} üëë\n\n"
                         "–í—ã –≤–æ—à–ª–∏ –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º ZATLAN TEA üçÉ.\n\n"
                         "–í–æ—Ç —á—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ –≤–∞–º:\n"
                         "üîπ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏\n"
                         "üîπ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞ —á–∞—è\n"
                         "üîπ –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –æ—Ç—á—ë—Ç–æ–≤\n"
                         "üîπ –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n\n"
                         "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –±–æ—Ç–æ–º:\n"
                         "/orders - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã\n"
                         "/inventory - –æ–±–Ω–æ–≤–∏—Ç—å –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç\n"
                         "/stats - –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–æ—Ç–∞\n\n"
                         "–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, –Ω–∞–ø–∏—à–∏—Ç–µ /help.\n\n"
                         "‚ú® –°–ø–∞—Å–∏–±–æ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ZATLAN TEA! üçµ"
                         )


@user_router.callback_query(F.data == "start_journey")
async def start_registration(callback: types.CallbackQuery, state: FSMContext):
    await callback.message.answer(
        "üåø –ü—Ä–µ–∂–¥–µ —á–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –≤ –Ω–∞—à–µ —á–∞–π–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ, –¥–∞–≤–∞–π –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è!üå∏\n\n"
        "–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç? üòä"
    )
    await state.set_state(Registration.name)
    await callback.answer()

# –ü—Ä–∏–Ω–∏–º–∞–µ–º –∏–º—è –∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä
@user_router.message(Registration.name)
async def get_name(message: types.Message, state: FSMContext):
    name = message.text.strip()

    long_name_responses = ([
        "–û–≥–æ, –∫–∞–∫–æ–µ –¥–ª–∏–Ω–Ω–æ–µ –∏–º—è! üòÖ\n–ú—ã, –∫–æ–Ω–µ—á–Ω–æ, –ª—é–±–∏–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏, –Ω–æ –ø–æ–ø—Ä–æ–±—É–π –Ω–∞–∑–≤–∞—Ç—å —Å–µ–±—è —á—É—Ç—å –∫–æ—Ä–æ—á–µ ‚Äî –Ω–µ —Ä–æ–º–∞–Ω –≤ —Ç—Ä—ë—Ö —Ç–æ–º–∞—Ö, –∞ –ø—Ä–æ—Å—Ç–æ –∏–º—è üçµ‚ú®",
        "–ò–º—è –ø–æ–ª—É—á–∏–ª–æ—Å—å –¥–ª–∏–Ω–Ω–µ–µ —á–∞–π–Ω–æ–≥–æ —Å–≤–∏—Ç–∫–∞! üìúüòÑ\n–î–∞–≤–∞–π –Ω–µ–º–Ω–æ–≥–æ —Å–æ–∫—Ä–∞—Ç–∏–º, —á—Ç–æ–±—ã –Ω–∞–º –≤—Å–µ–º –±—ã–ª–æ –ø—Ä–æ—â–µ –∑–∞–ø–æ–º–Ω–∏—Ç—å üçµ",
        "–û–≥–æ, —Ç–∞–∫–æ–µ –∏–º—è –∏ –≤ —á–∞–π–Ω–∏–∫ –Ω–µ —É–º–µ—Å—Ç–∏—Ç—å! üòÖ\n–ü–æ–ø—Ä–æ–±—É–π —á—Ç–æ-–Ω–∏–±—É–¥—å –ø–æ–∫–æ—Ä–æ—á–µ, –∫–∞–∫ –ª—é–±–∏–º–∞—è –∑–∞–≤–∞—Ä–∫–∞ üå±",
        "–¢–∞–∫–æ–µ –¥–ª–∏–Ω–Ω–æ–µ –∏–º—è ‚Äî –¥–æ—Å—Ç–æ–π–Ω–æ –ª–µ–≥–µ–Ω–¥—ã! üìñ‚ú®\n–ù–æ –Ω–∞–º –±—ã –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –ø–æ–∫–æ—Ä–æ—á–µ, –ª–∞–¥–Ω–æ? üòä",
        "–ò–º—è –≤–ø–µ—á–∞—Ç–ª—è–µ—Ç... –Ω–æ Telegram –º–æ–∂–µ—Ç –æ–±–∏–¥–µ—Ç—å—Å—è üòÖ\n–î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º –≤ 30 —Å–∏–º–≤–æ–ª–æ–≤ —É–ª–æ–∂–∏—Ç—å—Å—è, –∫–∞–∫ –≤ —É—é—Ç–Ω—É—é —á–∞—à–∫—É —á–∞—è ‚òï",
        "–í–∞—É, —Ç–∞–∫–æ–µ –∏–º—è –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –ø–∞—Ä–æ–ª—å –æ—Ç —Å–µ–π—Ñ–∞! üîêüòÑ\n–ù–æ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ª—É—á—à–µ —á—Ç–æ-—Ç–æ –ø–æ–∫–æ—Ä–æ—á–µ.",
        "–¢–∞–∫–æ–µ –∏–º—è ‚Äî —Ü–µ–ª–∞—è –ø–æ—ç–º–∞, –Ω–æ –Ω–∞–º —Ö–≤–∞—Ç–∏—Ç –∏ —Å—Ç—Ä–æ—á–∫–∏! üìúüòâ\n–ü–æ–ø—Ä–æ–±—É–π –Ω–∞–∑–≤–∞—Ç—å —Å–µ–±—è –ø–æ–∫–æ—Ä–æ—á–µ.",
        "–ö–∞–∂–µ—Ç—Å—è, —Ç–≤–æ–µ –∏–º—è –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞, —á–µ–º —á–∞—à–∫–∞ —Å —á–∞–µ–º –Ω–∞ —Å—Ç–æ–ª–µ! ‚òïüìè\n–î–∞–≤–∞–π —á—É—Ç—å –∫–æ—Ä–æ—á–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.",
        "–ò–º—è –≤–ø–µ—á–∞—Ç–ª—è–µ—Ç —Å–≤–æ–µ–π –¥–ª–∏–Ω–æ–π, –Ω–æ –¥–ª—è —á–∞—è –Ω—É–∂–Ω–∞ –ª—ë–≥–∫–æ—Å—Ç—å! üçÉüòå\n–ü–æ—Å—Ç–∞—Ä–∞–π—Å—è —É–º–µ—Å—Ç–∏—Ç—å—Å—è –≤ 30 —Å–∏–º–≤–æ–ª–æ–≤.",
        "–û–≥–æ, –∏–º—è —Å–ª–æ–≤–Ω–æ —Å–≤–∏—Ç–æ–∫ –¥—Ä–µ–≤–Ω–∏—Ö –∑–Ω–∞–Ω–∏–π! üìú‚ú®\n–ù–æ –¥–ª—è –±–æ—Ç–∞ —Å–¥–µ–ª–∞–µ–º –µ–≥–æ —á—É—Ç—å –∫–æ—Ä–æ—á–µ, –æ–∫–µ–π?",
        "–¢–∞–∫–æ–µ –¥–ª–∏–Ω–Ω–æ–µ –∏–º—è —Ç–æ—á–Ω–æ –∑–∞–ø–æ–º–Ω—è—Ç, –Ω–æ Telegram –º–æ–∂–µ—Ç —Å–±–∏—Ç—å—Å—è —Å —Ä–∏—Ç–º–∞! ü§ñüòÖ\n–î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ—â–µ.",
        "–ò–º—è –¥–ª–∏–Ω–æ–π —Å —á–∞–π–Ω—É—é —Ü–µ—Ä–µ–º–æ–Ω–∏—é, –Ω–æ –Ω–∞–º —Ö–≤–∞—Ç–∏—Ç 30 —Å–∏–º–≤–æ–ª–æ–≤. üçµ‚åõ\n–°–æ–∫—Ä–∞—Ç–∏, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.",
        "–≠—Ç–æ –∏–º—è –∫–∞–∫ –≥—É—Å—Ç–æ–π –Ω–∞—Å—Ç–æ–π ‚Äî –Ω–∞—Å—ã—â–µ–Ω–Ω–æ, –Ω–æ –Ω–µ–º–Ω–æ–≥–æ —Ç—è–∂–µ–ª–æ–≤–∞—Ç–æ! ‚òïüòâ\n–î–∞–≤–∞–π —á—É—Ç—å –ª–µ–≥—á–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞."
    ])


    if len(name) > 30:
        await message.answer(choice(long_name_responses))
        return  # –ù–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é

    await state.update_data(name=name)
    await message.answer(
        f"–û—Ç–ª–∏—á–Ω–æ, {name}! üçÉ\n"
        "–¢–µ–ø–µ—Ä—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å —Å–≤–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ üì≤",
        reply_markup=request_phone_keyboard
    )
    await state.set_state(Registration.number)

# –ü—Ä–∏–Ω–∏–º–∞–µ–º –Ω–æ–º–µ—Ä –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
@user_router.message(Registration.number, F.contact)
async def get_contact(message: types.Message, state: FSMContext):
    data = await state.get_data()  # –ü–æ–ª—É—á–∞–µ–º –≤—Å—ë, —á—Ç–æ –±—ã–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
    name = data.get("name")  # –î–æ—Å—Ç–∞—ë–º –∏–º—è
    phone = message.contact.phone_number  # –ù–æ–º–µ—Ä –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ –∂–µ–ª–∞–Ω–∏—é

    # –°—é–¥–∞ –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

    await message.answer(
        f"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! üéâ\n\n"
        f"{hbold(f'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–ª—É–± ZATLAN TEA, {name}!')} üçµ\n"
        "–¢–µ–ø–µ—Ä—å —Ç–µ–±–µ –¥–æ—Å—Ç—É–ø–Ω—ã –±–æ–Ω—É—Å—ã, —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.\n"
        "–ñ–µ–ª–∞–µ–º –∞—Ä–æ–º–∞—Ç–Ω—ã—Ö –æ—Ç–∫—Ä—ã—Ç–∏–π –∏ —É—é—Ç–Ω—ã—Ö —á–∞–π–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ üåø‚ú®",
        reply_markup=types.ReplyKeyboardRemove()
    )
    await state.clear()
